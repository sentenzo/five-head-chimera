version: "3"

services:

  frontend:
    image: fhc/frontend
    build:
      context: frontend
    ports:
      - 8888:80
    depends_on:
      - backend
    # volumes:
    #   - ./frontend/static:/app/static:ro

  backend:
    image: fhc/backend
    ports:
      - 9999:8000 # if changing local port, also change the URL in frontend/static/script.js
    build:
      context: ./backend
    env_file:
      - rabbitmq.env
    depends_on:
      rabbitmq:
        condition: service_healthy
    # volumes:
    #   - ./backend/service:/usr/src/app:ro

  rabbitmq:
    image: fhc/rabbitmq
    build:
      context: ./rabbitmq
    ports:
      - 5672:5672
      - 15672:15672 # the default user:pass is guest:guest
    volumes:
      - ./.docker-volumes/rabbitmq/data/:/var/lib/rabbitmq
      - ./.docker-volumes/rabbitmq/log/:/var/log/rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmqctl", "status" ]
      interval: 8s
      timeout: 5s
      retries: 10

  dbwriter:
    image: fhc/dbwriter
    build:
      context: ./dbwriter
    env_file:
      - rabbitmq.env
      - db.env
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy

  db:
    image: fhc/db
    build:
      context: ./db
    env_file:
      - db.env
    ports:
      - 6789:5432
    volumes:
      - ./.docker-volumes/db:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-d", "$(POSTGRES_DB)" ]
      interval: 8s
      timeout: 5s
      retries: 10
